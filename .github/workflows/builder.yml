name: Universal Kernel Builder

on:
  workflow_dispatch:
    inputs:
      kernel_source:
        description: 'ğŸ”— URL kernel source'
        required: true
        default: 'https://github.com/lynxdevproject/kernel-begonia'
      kernel_branch:
        description: 'ğŸŒ¿ Branch kernel source'
        required: true
        default: 'main'
      defconfig:
        description: 'ğŸ§ª Kernel defconfig'
        required: true
        default: 'begonia_user_defconfig'
      build_args:
        description: 'âš™ï¸ Extra build args (e.g., CONFIG flags) â€” If you don\'t know this, don\'t modify.'
        required: false
        default: 'CONFIG_CC_STACKPROTECTOR_STRONG=n'
      anykernel:
        description: 'ğŸ“¦ Use AnyKernel3 packaging?'
        required: true
        type: boolean
        default: true
      anykernel_repo:
        description: 'ğŸŒ URL AnyKernel3 repo'
        required: false
        default: 'https://github.com/osm0sis/AnyKernel3.git'
      anykernel_branch:
        description: 'ğŸŒ¿ Branch of AnyKernel3'
        required: false
        default: 'master'
      zip_name:
        description: 'ğŸ“ Output ZIP base name'
        required: false
        default: 'ReogKernel'
      developer:
        description: 'ğŸ‘¤ Your name/ID'
        required: false
        default: 'lynx@workspace'

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Jakarta
      OUT_DIR: out

    steps:
      - name: ğŸ§° Setup Toolchain
        run: |
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 aarch64-linux-android-4.9
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9 arm-linux-androideabi-4.9
          mkdir clang && curl -s https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/android14-dev/clang-r487747c.tar.gz -RLO && tar -C clang/ -xf clang-*.tar.gz

      - name: â±ï¸ Pull Kernel Source
        run: |
          git clone --depth=1 ${{ github.event.inputs.kernel_source }} -b ${{ github.event.inputs.kernel_branch }} kernel-source

      - name: âš™ï¸ Build Kernel
        run: |
          export KBUILD_BUILD_USER="${{ github.event.inputs.developer }}"
          export KBUILD_BUILD_HOST="workspace"
          export PATH=$GITHUB_WORKSPACE/clang/bin:${PATH}
          args="ARCH=arm64 \
                O=../out \
                ${{ github.event.inputs.build_args }} \
                CLANG_TRIPLE=aarch64-linux-gnu- \
                CROSS_COMPILE=$GITHUB_WORKSPACE/aarch64-linux-android-4.9/bin/aarch64-linux-android- \
                CROSS_COMPILE_ARM32=$GITHUB_WORKSPACE/arm-linux-androideabi-4.9/bin/arm-linux-androideabi-"
          cd kernel-source
          make ${args} ${{ github.event.inputs.defconfig }}
          make -j$(nproc) ${args}

      - name: ğŸ“¦ Package with AnyKernel3
        if: ${{ github.event.inputs.anykernel }}
        run: |
          git clone --depth=1 -b "${{ github.event.inputs.anykernel_branch }}" "${{ github.event.inputs.anykernel_repo }}" AnyKernel3
          rm -rf AnyKernel3/.git* AnyKernel3/LICENSE AnyKernel3/README.md
          IMG_PATH="out/arch/arm64/boot"
          for img in Image.gz-dtb Image-dtb Image.gz Image; do
            if [[ -f $IMG_PATH/$img ]]; then
              cp $IMG_PATH/$img AnyKernel3/$img
              break
            fi
          done
          if [[ -f $IMG_PATH/dtbo.img ]]; then
            cp $IMG_PATH/dtbo.img AnyKernel3/dtbo.img
          fi
          DATE=$(date +'%Y-%m-%d_%H-%M')
          ZIP_NAME="${{ github.event.inputs.zip_name }}-${{ github.event.inputs.developer }}-${DATE}.zip"
          cd AnyKernel3
          zip -r "${ZIP_NAME}" *

      - name: â˜ï¸ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-${{ github.event.inputs.developer }}
          path: |
            build.log
            out/arch/arm64/boot/*
            AnyKernel3/*.zip
